<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Lobo - V7.1 Visionario</title>
    
    <!-- LIBRER√çAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: system-ui, -apple-system, sans-serif; }
        .panel { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .input-dark { 
            background: #0f172a; border: 1px solid #475569; color: white; padding: 8px; border-radius: 6px; width: 100%; display: block; 
            appearance: none; -webkit-appearance: none; cursor: pointer;
        }
        .input-dark::-webkit-calendar-picker-indicator { filter: invert(1); }
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.2s; text-align: center; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #16a34a; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-ghost { background: transparent; border: 1px solid #475569; color: #94a3b8; }
        .btn-ghost:hover { background: #334155; color: white; }
        
        /* Animaciones */
        @keyframes confetti-fall { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(100vh) rotate(720deg); } }
        .confetti { position: fixed; top: -10px; width: 10px; height: 10px; z-index: 100; animation: confetti-fall 3s linear forwards; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; items-center: center; z-index: 50; padding: 20px; }
        .modal-content { background: #1e293b; padding: 24px; border-radius: 12px; width: 100%; max-width: 600px; border: 1px solid #475569; max-height: 90vh; overflow-y: auto; margin-top: 5vh; }
        .digital-clock { font-variant-numeric: tabular-nums; letter-spacing: 0.05em; text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Slider custom */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
    </style>

    <!-- FIREBASE MODULES -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "firebase/app": "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js"
        }
      }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';

        // --- 1. CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAjtOyY2gUETMA3b24DBwFf9eR8AWQ8wLI",
          authDomain: "presupuesto-rigo.firebaseapp.com",
          projectId: "presupuesto-rigo",
          storageBucket: "presupuesto-rigo.firebasestorage.app",
          messagingSenderId: "715259896738",
          appId: "1:715259896738:web:cd15867c98bbd325c708fb",
          measurementId: "G-67MS7XNCXM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. DATOS INICIALES ---
        const INITIAL_BUDGET_CONFIG = {
            "ESENCIALES": { limit: 12000, categories: { "HIPOTECA": 3600, "SERVICIOS": 1000, "DESPENSA": 1000, "SGMM": 1700, "PERLA": 2000, "SEGURO CARRO": 650, "COMPRAS": 650, "PRESTAMO PERSONAL": 1400 } },
            "PERSONALES": { limit: 4800, categories: { "TDC": 2000, "SUSCRIPCIONES": 800, "SALIDAS": 1000, "COMPRAS": 1000 } },
            "AHORRO": { limit: 7200, categories: { "PPR": 3200, "AHORRO GENERAL": 4000 } }
        };

        const INITIAL_DATA = {
            assets: [
                { id: 1, name: "Casa MTY", value: 2000000, type: "real_estate" },
                { id: 2, name: "Casa Oaxaca", value: 450000, type: "real_estate" },
                { id: 3, name: "PPR Allianz", value: 53272, type: "investment" },
                { id: 4, name: "GBM (SPLG)", value: 46000, type: "investment" },
                { id: 5, name: "Fondo Emergencia", value: 35000, type: "cash" },
                { id: 6, name: "Afore", value: 300000, type: "investment" },
                { id: 7, name: "CIJubilate", value: 760000, type: "investment" },
                { id: 8, name: "CETES / Udibonos", value: 0, type: "investment" },
                { id: 9, name: "Fondo Viajes", value: 500, type: "cash" }
            ],
            debts: [
                { id: 101, name: "Pr√©stamo Personal (32%)", value: 150000, rate: 32, type: "toxic" },
                { id: 102, name: "Hipoteca MTY (8.7%)", value: 260000, rate: 8.7, type: "good" }
            ],
            budgetConfig: INITIAL_BUDGET_CONFIG, 
            transactions: [], incomes: [], highestNetWorth: 0,
            targetDate: "2041-11-03"
        };

        // --- 3. GR√ÅFICAS SVG ---
        const SimplePieChart = ({ data }) => {
            const total = data.reduce((acc, item) => acc + item.value, 0);
            let currentAngle = 0;
            if (total === 0) return <div className="flex h-full items-center justify-center text-gray-500">Sin datos</div>;
            return (
                <div className="flex flex-col items-center justify-center h-full">
                    <div className="relative w-40 h-40 rounded-full overflow-hidden border-4 border-slate-700" 
                         style={{ background: `conic-gradient(${data.map(item => { const start = currentAngle; const percentage = (item.value / total) * 100; const end = currentAngle + percentage; currentAngle = end; return `${item.fill} ${start}% ${end}%`; }).join(', ')})` }}>
                        <div className="absolute inset-0 m-auto w-20 h-20 bg-slate-900 rounded-full flex items-center justify-center border-4 border-slate-700"><span className="text-xs font-bold text-gray-400">Total</span></div>
                    </div>
                    <div className="mt-4 grid grid-cols-2 gap-2 text-xs">
                        {data.map((item, idx) => (
                            <div key={idx} className="flex items-center gap-1"><div className="w-3 h-3 rounded-full" style={{backgroundColor: item.fill}}></div><span>{item.name} ({Math.round((item.value/total)*100)}%)</span></div>
                        ))}
                    </div>
                </div>
            );
        };

        const SimpleBarChart = ({ data }) => {
            const maxValue = Math.max(...data.map(d => d.value), 1);
            return (
                <div className="flex flex-col gap-2 h-full overflow-y-auto pr-2">
                    {data.map((item, idx) => (
                        <div key={idx} className="flex items-center gap-2 text-xs">
                            <div className="w-24 truncate text-right text-gray-400" title={item.name}>{item.name}</div>
                            <div className="flex-1 h-4 bg-slate-800 rounded overflow-hidden relative">
                                <div className="h-full rounded" style={{ width: `${(item.value / maxValue) * 100}%`, backgroundColor: idx % 2 === 0 ? '#8b5cf6' : '#6366f1' }}></div>
                            </div>
                            <div className="w-16 text-right font-mono">${item.value.toLocaleString()}</div>
                        </div>
                    ))}
                    {data.length === 0 && <div className="text-center text-gray-500 py-10">Sin gastos registrados</div>}
                </div>
            );
        };

        const TrendLineChart = ({ transactions, totalBudget, daysInMonth }) => {
            const dailyData = Array(daysInMonth).fill(0);
            transactions.forEach(t => {
                const day = parseInt(t.date.split('-')[2]) - 1;
                if (day >= 0 && day < daysInMonth) dailyData[day] += t.amount;
            });
            let accumulator = 0;
            const cumulativeData = dailyData.map((amount, idx) => {
                const today = new Date().getDate();
                if (idx + 1 > today) return null; 
                accumulator += amount;
                return accumulator;
            }).filter(val => val !== null);
            if (cumulativeData.length === 0) return <div className="h-full flex items-center justify-center text-gray-500 text-xs">Registra gastos para ver la tendencia</div>;
            const maxVal = Math.max(totalBudget, ...cumulativeData) * 1.1; 
            const width = 100; const height = 100; 
            const points = cumulativeData.map((val, idx) => {
                const x = (idx / (daysInMonth - 1)) * width;
                const y = height - ((val / maxVal) * height);
                return `${x},${y}`;
            }).join(' ');
            const budgetY = height - ((totalBudget / maxVal) * height);
            return (
                <div className="relative w-full h-full p-2">
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible" preserveAspectRatio="none">
                        <line x1="0" y1={height} x2={width} y2={height} stroke="#334155" strokeWidth="1" />
                        <line x1="0" y1="0" x2="0" y2={height} stroke="#334155" strokeWidth="1" />
                        <line x1="0" y1={budgetY} x2={width} y2={budgetY} stroke="#64748b" strokeWidth="0.5" strokeDasharray="2" />
                        <text x="1" y={budgetY - 2} fontSize="4" fill="#64748b">L√≠mite: ${totalBudget.toLocaleString()}</text>
                        <polyline points={points} fill="none" stroke="#ef4444" strokeWidth="1.5" vectorEffect="non-scaling-stroke" />
                        {cumulativeData.map((val, idx) => {
                             const x = (idx / (daysInMonth - 1)) * width;
                             const y = height - ((val / maxVal) * height);
                             return (<circle key={idx} cx={x} cy={y} r="1.5" fill="#ef4444" className="chart-point" />)
                        })}
                    </svg>
                </div>
            );
        };

        // --- ACTUALIZACI√ìN GR√ÅFICA PROYECCI√ìN: SOPORTE PARA METAS ---
        const ProjectionChart = ({ years, currentNetWorth, annualReturn, monthlySavings, targetCapital, targetYears }) => {
            const chartPoints = [];
            let projectedNW = currentNetWorth;
            const displayYears = Math.max(years, targetYears + 2); // Asegurar que la gr√°fica cubra el a√±o meta
            
            for (let i = 0; i <= displayYears; i++) {
                chartPoints.push({ year: i, value: projectedNW });
                projectedNW = (projectedNW * (1 + annualReturn)) + (monthlySavings * 12);
            }

            const maxVal = Math.max(targetCapital * 1.2, projectedNW);
            const width = 100; const height = 100; 
            
            // Coordenadas Curva Crecimiento
            const points = chartPoints.map((p, idx) => {
                const x = (idx / displayYears) * width;
                const y = height - ((p.value / maxVal) * height);
                return `${x},${y}`;
            }).join(' ');

            // Coordenadas Meta (Punto Espec√≠fico)
            const targetX = (targetYears / displayYears) * width;
            const targetY = height - ((targetCapital / maxVal) * height);

            return (
                <div className="relative w-full h-64 p-4 bg-slate-900 rounded border border-slate-700 mt-4">
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible" preserveAspectRatio="none">
                        {/* Ejes */}
                        <line x1="0" y1={height} x2={width} y2={height} stroke="#475569" strokeWidth="1" />
                        <line x1="0" y1="0" x2="0" y2={height} stroke="#475569" strokeWidth="1" />
                        
                        {/* Curva Proyecci√≥n */}
                        <polyline points={points} fill="none" stroke="#22c55e" strokeWidth="2" />
                        <polygon points={`0,${height} ${points} ${width},${height}`} fill="rgba(34, 197, 94, 0.1)" />

                        {/* META DEL USUARIO (Estrella o Punto destacado) */}
                        <circle cx={targetX} cy={targetY} r="3" fill="#eab308" stroke="white" strokeWidth="0.5" />
                        <line x1={targetX} y1={targetY} x2={targetX} y2={height} stroke="#eab308" strokeWidth="0.5" strokeDasharray="2" />
                        <text x={targetX - 5} y={targetY - 5} fontSize="4" fill="#eab308" fontWeight="bold">META</text>
                    </svg>
                    <div className="absolute bottom-0 left-0 text-xs text-gray-500">Hoy</div>
                    <div className="absolute bottom-0 right-0 text-xs text-gray-500">+{displayYears} A√±os</div>
                </div>
            );
        };

        // --- UTILS ---
        const fireConfetti = () => {
            const colors = ['#ef4444', '#22c55e', '#3b82f6', '#eab308'];
            for (let i = 0; i < 100; i++) {
                const el = document.createElement('div');
                el.classList.add('confetti');
                el.style.left = Math.random() * 100 + 'vw';
                el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                el.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 4000);
            }
        };

        const formatMonth = (dateString) => {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('es-MX', { month: 'long', year: 'numeric', timeZone: 'UTC' }).format(date).toUpperCase();
        };

        // --- 4. APP PRINCIPAL ---
        const App = () => {
            // ESTADOS
            const [user, setUser] = useState(null);
            const [data, setData] = useState(null); 
            const [loading, setLoading] = useState(true);
            const [syncStatus, setSyncStatus] = useState('disconnected');

            const [view, setView] = useState('simulator'); // Iniciar en simulador
            const [currentDate, setCurrentDate] = useState(new Date());
            const [editingItem, setEditingItem] = useState(null); 
            const [editingTx, setEditingTx] = useState(null); 
            const [paymentItem, setPaymentItem] = useState(null);
            const [configModalOpen, setConfigModalOpen] = useState(false);
            const [targetDateModalOpen, setTargetDateModalOpen] = useState(false); 

            // --- FIREBASE AUTH & SYNC ---
            useEffect(() => {
                const initAuth = async () => {
                    try { await signInAnonymously(auth); } catch (error) { console.error("Auth:", error); setSyncStatus('error'); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        const docRef = doc(db, 'users', u.uid);
                        onSnapshot(docRef, (snap) => {
                            if (snap.exists()) { setData(snap.data()); setSyncStatus('saved'); } 
                            else { setDoc(docRef, INITIAL_DATA); setData(INITIAL_DATA); }
                            setLoading(false);
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            const saveData = async (newData) => {
                setData(newData); setSyncStatus('syncing');
                if (user) { try { await setDoc(doc(db, 'users', user.uid), newData); setSyncStatus('saved'); } catch (e) { setSyncStatus('error'); } }
            };

            if (loading || !data) return <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center gap-4 text-white"><div className="loader"></div><p>Cargando Plan Lobo Cloud...</p></div>;

            // --- C√ÅLCULOS GENERALES ---
            const totalAssets = data.assets.reduce((sum, i) => sum + Number(i.value), 0);
            const totalDebts = data.debts.reduce((sum, i) => sum + Number(i.value), 0);
            const netWorth = totalAssets - totalDebts;
            
            const getMonthKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const activeMonthKey = getMonthKey(currentDate);
            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const daysInCurrentMonth = getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth());

            const monthlyTransactions = data.transactions.filter(t => t.date.startsWith(activeMonthKey));
            const monthlyIncomes = data.incomes.filter(i => i.date.startsWith(activeMonthKey));
            const totalMonthlyIncome = monthlyIncomes.reduce((acc, i) => acc + i.amount, 0);
            const totalMonthlyExpenses = monthlyTransactions.reduce((acc, t) => acc + t.amount, 0);

            // --- ACCIONES ---
            const addAsset = (name, value, type) => { saveData({ ...data, assets: [...data.assets, { id: Date.now(), name, value: Number(value), type }] }); };
            const updateItem = (type, id, val, rate, name) => { if (type === 'asset') saveData({...data, assets: data.assets.map(a => a.id === id ? { ...a, value: Number(val), name: name } : a)}); else saveData({...data, debts: data.debts.map(d => d.id === id ? { ...d, value: Number(val), rate: Number(rate), name: name } : d)}); setEditingItem(null); };
            const handlePayment = (amount) => { if (!paymentItem) return; const val = Number(amount); if (!val) return; if (paymentItem.type === 'asset') saveData({ ...data, assets: data.assets.map(a => a.id === paymentItem.item.id ? { ...a, value: a.value + val } : a) }); else saveData({ ...data, debts: data.debts.map(d => d.id === paymentItem.item.id ? { ...d, value: d.value - val } : d) }); setPaymentItem(null); fireConfetti(); };
            const addTransaction = (tx, date) => { saveData({ ...data, transactions: [...data.transactions, { ...tx, id: Date.now(), date }] }); };
            const addIncome = (inc, date) => { saveData({ ...data, incomes: [...data.incomes, { ...inc, id: Date.now(), date }] }); };
            const deleteHistoryItem = (type, id) => { if(!confirm("¬øBorrar?")) return; if(type === 'income') saveData({ ...data, incomes: data.incomes.filter(i => i.id !== id) }); else saveData({ ...data, transactions: data.transactions.filter(t => t.id !== id) }); };
            const saveTransactionChanges = (id, type, newAmount, newComment, newCategory, newSection, newDate) => { if(type === 'income') saveData({ ...data, incomes: data.incomes.map(i => i.id === id ? { ...i, amount: Number(newAmount), comment: newComment, source: newCategory, date: newDate } : i) }); else saveData({ ...data, transactions: data.transactions.map(t => t.id === id ? { ...t, amount: Number(newAmount), comment: newComment, category: newCategory, section: newSection, date: newDate } : t) }); setEditingTx(null); };
            
            const updateBudgetSectionLimit = (section, newLimit) => { saveData({ ...data, budgetConfig: { ...data.budgetConfig, [section]: { ...data.budgetConfig[section], limit: Number(newLimit) } } }); };
            const updateBudgetCategoryLimit = (section, category, newLimit) => { saveData({ ...data, budgetConfig: { ...data.budgetConfig, [section]: { ...data.budgetConfig[section], categories: { ...data.budgetConfig[section].categories, [category]: Number(newLimit) } } } }); };
            const addBudgetCategory = (section, categoryName, limit) => { if(!categoryName) return; saveData({ ...data, budgetConfig: { ...data.budgetConfig, [section]: { ...data.budgetConfig[section], categories: { ...data.budgetConfig[section].categories, [categoryName.toUpperCase()]: Number(limit) } } } }); };
            const deleteBudgetCategory = (section, categoryName) => { if(!confirm(`¬øBorrar ${categoryName}?`)) return; const newCategories = { ...data.budgetConfig[section].categories }; delete newCategories[categoryName]; saveData({ ...data, budgetConfig: { ...data.budgetConfig, [section]: { ...data.budgetConfig[section], categories: newCategories } } }); };
            const addBudgetSection = (sectionName) => { if(!sectionName) return; saveData({ ...data, budgetConfig: { ...data.budgetConfig, [sectionName.toUpperCase()]: { limit: 0, categories: {} } } }); };
            const deleteBudgetSection = (sectionName) => { if(!confirm(`¬øBorrar ${sectionName}?`)) return; const newConfig = { ...data.budgetConfig }; delete newConfig[sectionName]; saveData({ ...data, budgetConfig: newConfig }); };
            const updateTargetDate = (newDate) => { saveData({ ...data, targetDate: newDate }); setTargetDateModalOpen(false); };

            // --- VISTA 4: SIMULADOR (MODIFICADA: INPUTS EDITABLES) ---
            const SimulatorView = () => {
                const [annualReturn, setAnnualReturn] = useState(8); 
                const [inflation, setInflation] = useState(4); 
                const [monthlySavings, setMonthlySavings] = useState(7200); 
                
                // NUEVOS ESTADOS PARA OBJETIVOS EDITABLES
                const [manualTargetYears, setManualTargetYears] = useState(15); 
                const [manualTargetCapital, setManualTargetCapital] = useState(7500000); 

                const realReturn = (annualReturn - inflation) / 100;
                const annualSavings = monthlySavings * 12;

                // Proyecci√≥n en el a√±o META (para ver si llegas o no)
                let projectedAtTarget = netWorth;
                for(let i=0; i<manualTargetYears; i++) {
                    projectedAtTarget = (projectedAtTarget * (1 + realReturn)) + annualSavings;
                }
                
                const gap = projectedAtTarget - manualTargetCapital;
                const isGoalMet = gap >= 0;

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="panel bg-indigo-900/20 border-indigo-500 text-center mb-6">
                            <h2 className="text-2xl font-bold text-indigo-400 mb-1">üîÆ BOLA DE CRISTAL FINANCIERA</h2>
                            <p className="text-sm text-gray-400">Define tus propias reglas. Mira la realidad a los ojos.</p>
                        </div>

                        {/* CONTROLES */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="panel">
                                <h3 className="font-bold mb-4 text-gray-300">1. El Mercado</h3>
                                <div className="mb-4">
                                    <div className="flex justify-between text-sm mb-1"><span>Retorno Anual</span><span className="text-green-400 font-bold">{annualReturn}%</span></div>
                                    <input type="range" min="1" max="15" step="0.5" value={annualReturn} onChange={e=>setAnnualReturn(Number(e.target.value))} className="w-full" />
                                </div>
                                <div>
                                    <div className="flex justify-between text-sm mb-1"><span>Inflaci√≥n</span><span className="text-red-400 font-bold">{inflation}%</span></div>
                                    <input type="range" min="1" max="10" step="0.5" value={inflation} onChange={e=>setInflation(Number(e.target.value))} className="w-full" />
                                    <div className="text-right text-xs text-gray-500 mt-1">Real: {(annualReturn - inflation).toFixed(1)}%</div>
                                </div>
                            </div>

                            <div className="panel">
                                <h3 className="font-bold mb-4 text-gray-300">2. Tu Esfuerzo</h3>
                                <div className="mb-4">
                                    <label className="block text-xs text-gray-500 mb-1">Ahorro Mensual</label>
                                    <input type="number" value={monthlySavings} onChange={e=>setMonthlySavings(Number(e.target.value))} className="input-dark font-mono text-lg" />
                                </div>
                                <p className="text-xs text-gray-500">Lo que pones de tu bolsillo mes a mes para comprar tu libertad.</p>
                            </div>

                            {/* SECCI√ìN NUEVA: OBJETIVOS MANUALES */}
                            <div className="panel border-l-4 border-yellow-500">
                                <h3 className="font-bold mb-4 text-yellow-400">3. Tus Objetivos (Editables)</h3>
                                <div className="mb-4">
                                    <label className="block text-xs text-gray-500 mb-1">¬øEn cu√°ntos a√±os te quieres retirar?</label>
                                    <input type="number" value={manualTargetYears} onChange={e=>setManualTargetYears(Number(e.target.value))} className="input-dark font-mono text-lg text-yellow-300" />
                                </div>
                                <div>
                                    <label className="block text-xs text-gray-500 mb-1">¬øCon cu√°nto capital?</label>
                                    <input type="number" value={manualTargetCapital} onChange={e=>setManualTargetCapital(Number(e.target.value))} className="input-dark font-mono text-lg text-yellow-300" />
                                </div>
                            </div>
                        </div>

                        {/* RESULTADOS: COMPARACI√ìN REAL VS META */}
                        <div className="panel text-center">
                            <h3 className="font-bold mb-4 text-gray-300 border-b border-gray-700 pb-2">VEREDICTO DEL SIMULADOR</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                                <div>
                                    <div className="text-xs text-gray-400 uppercase font-bold mb-1">En {manualTargetYears} a√±os tendr√°s proyectado:</div>
                                    <div className="text-4xl font-bold text-white mb-4">${projectedAtTarget.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                                    
                                    <div className="text-xs text-gray-400 uppercase font-bold mb-1">Tu meta era:</div>
                                    <div className="text-2xl font-bold text-yellow-500 mb-4">${manualTargetCapital.toLocaleString()}</div>
                                </div>
                                
                                <div className={`p-4 rounded-lg border ${isGoalMet ? 'bg-green-900/30 border-green-500' : 'bg-red-900/30 border-red-500'}`}>
                                    <div className="text-lg font-bold mb-2">{isGoalMet ? '‚úÖ LO LOGRAS' : '‚ö†Ô∏è TE QUEDAS CORTO'}</div>
                                    <div className="text-sm text-gray-300 mb-2">
                                        {isGoalMet 
                                            ? `Te sobran $${gap.toLocaleString()} por encima de tu meta. Est√°s sobrado, vive un poco m√°s.` 
                                            : `Te faltan $${Math.abs(gap).toLocaleString()} para tu meta.`}
                                    </div>
                                    {!isGoalMet && (
                                        <div className="text-xs bg-slate-800 p-2 rounded text-red-300">
                                            Consejo: Necesitas ahorrar <strong>${(monthlySavings + (Math.abs(gap) / manualTargetYears / 12)).toLocaleString(undefined, {maximumFractionDigits: 0})}</strong>/mes aprox. para llegar a tiempo.
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* GR√ÅFICA DE PROYECCI√ìN ACTUALIZADA */}
                        <div className="panel">
                            <h3 className="font-bold mb-4 text-gray-300">Trayectoria vs Meta</h3>
                            <ProjectionChart 
                                years={manualTargetYears + 5} 
                                currentNetWorth={netWorth} 
                                annualReturn={realReturn} 
                                monthlySavings={monthlySavings}
                                targetCapital={manualTargetCapital}
                                targetYears={manualTargetYears}
                            />
                        </div>
                    </div>
                );
            };

            const GlobalView = () => {
                const [newName, setNewName] = useState(""); const [newValue, setNewValue] = useState(""); const [newType, setNewType] = useState("investment");
                return (
                    <div className="space-y-8 animate-fade-in">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="panel border-l-4 border-blue-500"><div className="text-sm text-blue-300 font-bold tracking-widest">PATRIMONIO NETO</div><div className="text-4xl font-bold text-white mt-2">${netWorth.toLocaleString()}</div></div>
                            <div className="panel border-l-4 border-green-500"><div className="text-sm text-green-300 font-bold tracking-widest">ACTIVOS</div><div className="text-4xl font-bold text-white mt-2">${totalAssets.toLocaleString()}</div></div>
                            <div className="panel border-l-4 border-red-500"><div className="text-sm text-red-300 font-bold tracking-widest">DEUDAS</div><div className="text-4xl font-bold text-white mt-2">${totalDebts.toLocaleString()}</div></div>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div className="space-y-4"><div className="flex justify-between items-end border-b border-gray-700 pb-2"><h3 className="text-xl font-bold text-green-400">üè∞ Tus Activos</h3><span className="text-xs text-gray-500">Clic texto para editar | Clic + para abonar</span></div>{data.assets.map(asset => (<div key={asset.id} className="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-700"><div onClick={() => setEditingItem({...asset, itemType: 'asset'})} className="cursor-pointer flex-1"><div className="font-bold text-slate-200">{asset.name}</div><div className="text-xs text-gray-500 uppercase">{asset.type === 'real_estate' ? 'üè† Inmueble' : 'üí∞ Financiero'}</div></div><div className="flex items-center gap-3"><div className="text-xl font-mono font-bold text-green-400">${asset.value.toLocaleString()}</div>{asset.type !== 'real_estate' && (<button onClick={() => setPaymentItem({ item: asset, type: 'asset' })} className="w-8 h-8 rounded-full bg-green-900 text-green-400 hover:bg-green-700 flex items-center justify-center font-bold text-lg" title="Abonar ahorro">+</button>)}</div></div>))}<div className="panel bg-slate-800/50 border-dashed border-gray-600 mt-4"><div className="text-xs font-bold text-gray-400 mb-2">AGREGAR NUEVO ACTIVO</div><div className="flex gap-2 mb-2"><input placeholder="Nombre" value={newName} onChange={e=>setNewName(e.target.value)} className="input-dark w-1/3" /><input type="number" placeholder="$ Valor" value={newValue} onChange={e=>setNewValue(e.target.value)} className="input-dark w-1/3" /><select value={newType} onChange={e=>setNewType(e.target.value)} className="input-dark w-1/3"><option value="investment">Inversi√≥n</option><option value="real_estate">Inmueble</option><option value="cash">Efectivo</option></select></div><button onClick={() => {if(newName && newValue) { addAsset(newName, newValue, newType); setNewName(""); setNewValue(""); }}} className="btn btn-primary w-full text-xs">Guardar Nuevo</button></div></div>
                            <div className="space-y-4"><div className="flex justify-between items-end border-b border-gray-700 pb-2"><h3 className="text-xl font-bold text-red-400">‚öîÔ∏è Tus Deudas</h3><span className="text-xs text-gray-500">Clic texto para editar | Clic ‚Üì para pagar</span></div>{data.debts.map(debt => (<div key={debt.id} className={`flex justify-between items-center p-3 bg-slate-800 rounded-lg border-l-4 ${debt.type === 'toxic' ? 'border-red-500' : 'border-green-500'}`}><div onClick={() => setEditingItem({...debt, itemType: 'debt'})} className="cursor-pointer flex-1"><div className="font-bold text-slate-200">{debt.name}</div><div className="text-xs text-gray-500">Tasa: {debt.rate}% Anual</div></div><div className="flex items-center gap-3"><div className="text-xl font-mono font-bold text-red-400">${debt.value.toLocaleString()}</div><button onClick={() => setPaymentItem({ item: debt, type: 'debt' })} className="w-8 h-8 rounded-full bg-red-900 text-red-400 hover:bg-red-700 flex items-center justify-center font-bold" title="Abonar a deuda">‚Üì</button></div></div>))}</div>
                        </div>
                    </div>
                );
            };

            const MonthlyView = () => {
                const spentBySection = {}; const spentByCategory = {};
                Object.keys(data.budgetConfig).forEach(sec => spentBySection[sec] = 0);
                monthlyTransactions.forEach(t => { spentBySection[t.section] = (spentBySection[t.section] || 0) + t.amount; spentByCategory[t.category] = (spentByCategory[t.category] || 0) + t.amount; });
                const pieData = Object.keys(data.budgetConfig).map((sec, idx) => ({ name: sec, value: spentBySection[sec] || 0, fill: ['#3b82f6', '#eab308', '#22c55e', '#a855f7', '#ec4899'][idx % 5] }));
                const barData = Object.entries(spentByCategory).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
                const totalMonthlyBudget = Object.values(data.budgetConfig).reduce((acc, curr) => acc + curr.limit, 0);
                
                const today = new Date().toISOString().split('T')[0];
                const [mode, setMode] = useState('expense'); 
                const [amount, setAmount] = useState(""); 
                const [section, setSection] = useState(Object.keys(data.budgetConfig)[0]); 
                const [category, setCategory] = useState(Object.keys(data.budgetConfig[section]?.categories || {})[0] || ""); 
                const [comment, setComment] = useState(""); 
                const [source, setSource] = useState("SALARIO");
                const [date, setDate] = useState(today); 

                const handleSectionChange = (e) => { const newSec = e.target.value; setSection(newSec); const firstCat = Object.keys(data.budgetConfig[newSec]?.categories || {})[0]; setCategory(firstCat || ""); };
                
                const submit = (e) => { 
                    e.preventDefault(); 
                    if (!amount || !date) return; 
                    if (mode === 'expense') addTransaction({ section, category, amount: Number(amount), comment }, date); 
                    else addIncome({ source, amount: Number(amount), comment }, date); 
                    setAmount(""); setComment(""); 
                };
                
                const allHistory = [...monthlyIncomes.map(i => ({ ...i, type: 'income', displayCategory: i.source, isPositive: true })), ...monthlyTransactions.map(t => ({ ...t, type: 'expense', displayCategory: t.category, isPositive: false }))].sort((a, b) => b.id - a.id);
                const exportToExcel = () => { const wsData = [["Fecha", "Tipo", "Categor√≠a/Fuente", "Comentario", "Monto"], ...allHistory.map(item => [item.date, item.isPositive ? "INGRESO" : "GASTO", item.displayCategory, item.comment, item.amount])]; const ws = XLSX.utils.aoa_to_sheet(wsData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Movimientos"); XLSX.writeFile(wb, `Lobo_Respaldo_${activeMonthKey}.xlsx`); };

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="flex items-center justify-between bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <button onClick={() => { const d = new Date(currentDate); d.setMonth(d.getMonth()-1); setCurrentDate(d); }} className="btn btn-ghost"><i className="ri-arrow-left-s-line"></i></button>
                            <div className="text-center"><div className="text-xs text-blue-400 font-bold tracking-widest">GESTI√ìN MENSUAL</div><div className="text-2xl font-bold text-white">{formatMonth(`${activeMonthKey}-01`)}</div></div>
                            <div className="flex items-center gap-2">
                                <button onClick={exportToExcel} className="btn bg-green-700 hover:bg-green-600 text-white text-xs md:text-sm" title="Descargar Excel"><i className="ri-file-excel-2-line"></i> <span className="hidden md:inline">Respaldar Mes</span></button>
                                <button onClick={() => setConfigModalOpen(true)} className="btn bg-slate-700 hover:bg-slate-600 text-white text-xs md:text-sm"><i className="ri-settings-4-line"></i> <span className="hidden md:inline">Config</span></button>
                                <button onClick={() => { const d = new Date(currentDate); d.setMonth(d.getMonth()+1); setCurrentDate(d); }} className="btn btn-ghost"><i className="ri-arrow-right-s-line"></i></button>
                            </div>
                        </div>
                        <div className="panel overflow-hidden border border-slate-600"><h3 className="font-bold mb-4 text-lg flex items-center gap-2 text-yellow-400"><i className="ri-history-line"></i> Bit√°cora de Operaciones</h3><div className="overflow-x-auto max-h-80"><table className="w-full text-sm text-left border-collapse"><thead className="text-gray-400 bg-slate-800 text-xs uppercase sticky top-0"><tr><th className="p-3">Fecha</th><th className="p-3">Tipo</th><th className="p-3">Concepto</th><th className="p-3">Comentario</th><th className="p-3 text-right">Monto</th><th className="p-3 text-center">Acciones</th></tr></thead><tbody className="divide-y divide-slate-700">{allHistory.map((item) => (<tr key={item.id} className="hover:bg-slate-800/50 group"><td className="p-3 whitespace-nowrap text-gray-400">{item.date}</td><td className="p-3"><span className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${item.isPositive ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`}>{item.isPositive ? 'Ingreso' : 'Gasto'}</span></td><td className="p-3 font-bold text-slate-200">{item.displayCategory}</td><td className="p-3 text-gray-500 italic">{item.comment || '-'}</td><td className={`p-3 text-right font-mono font-bold ${item.isPositive ? 'text-green-400' : 'text-red-400'}`}>{item.isPositive ? '+' : '-'}${item.amount.toLocaleString()}</td><td className="p-3 text-center flex justify-center gap-2"><button onClick={() => setEditingTx(item)} className="p-1 text-blue-400 hover:text-blue-300 transition" title="Editar"><i className="ri-pencil-line text-lg"></i></button><button onClick={() => deleteHistoryItem(item.type, item.id)} className="p-1 text-red-500 hover:text-red-400 transition" title="Borrar"><i className="ri-delete-bin-line text-lg"></i></button></td></tr>))}{allHistory.length === 0 && (<tr><td colSpan="6" className="p-8 text-center text-gray-500">No hay movimientos registrados en este mes.</td></tr>)}</tbody></table></div></div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6"><div className="panel h-80"><h4 className="text-center text-xs font-bold text-gray-400 mb-2">DISTRIBUCI√ìN REAL</h4><SimplePieChart data={pieData} /></div><div className="panel h-80"><h4 className="text-center text-xs font-bold text-gray-400 mb-2">GASTO POR CATEGOR√çA</h4><SimpleBarChart data={barData} /></div></div>
                        <div className="panel border-t-4 border-yellow-500">
                            <div className="flex gap-4 mb-4 bg-slate-900 p-1 rounded-lg">
                                <button onClick={()=>setMode('expense')} className={`flex-1 py-2 rounded font-bold text-sm transition ${mode==='expense'?'bg-red-600 text-white':'text-gray-400'}`}>Registrar Gasto</button>
                                <button onClick={()=>setMode('income')} className={`flex-1 py-2 rounded font-bold text-sm transition ${mode==='income'?'bg-green-600 text-white':'text-gray-400'}`}>Registrar Ingreso</button>
                            </div>
                            <form onSubmit={submit} className="grid grid-cols-1 md:grid-cols-5 gap-3 items-end"> 
                                <div>
                                    <label className="text-[10px] text-gray-500">Fecha</label>
                                    <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="input-dark" required />
                                </div>
                                {mode === 'expense' ? (
                                    <>
                                    <div><label className="text-[10px] text-gray-500">Secci√≥n</label><select value={section} onChange={handleSectionChange} className="input-dark">{Object.keys(data.budgetConfig).map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                                    <div><label className="text-[10px] text-gray-500">Categor√≠a</label><select value={category} onChange={e => setCategory(e.target.value)} className="input-dark">{data.budgetConfig[section] && Object.keys(data.budgetConfig[section].categories).map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                    </>
                                ) : (
                                    <div className="md:col-span-2"><label className="text-[10px] text-gray-500">Fuente</label><select value={source} onChange={e => setSource(e.target.value)} className="input-dark"><option value="SALARIO">Salario N√≥mina</option><option value="VALES">Vales de Despensa</option><option value="AGUINALDO">Aguinaldo</option><option value="FONDO AHORRO">Fondo de Ahorro</option><option value="EXTRA">Ingreso Extra / Venta</option></select></div>
                                )}
                                <div><label className="text-[10px] text-gray-500">Monto</label><input type="number" value={amount} onChange={e=>setAmount(e.target.value)} className="input-dark" placeholder="$0.00" /></div>
                                <button className="btn btn-primary h-[38px] w-full"><i className="ri-save-3-line"></i> Guardar</button>
                                <div className="md:col-span-5">
                                    <label className="text-[10px] text-gray-500">Comentario / Descripci√≥n</label>
                                    <input type="text" value={comment} onChange={e=>setComment(e.target.value)} className="input-dark" placeholder="Detalle del movimiento" />
                                </div>
                            </form>
                        </div>
                        <div className="panel h-64 border-t-4 border-orange-500"><h4 className="text-center text-xs font-bold text-gray-400 mb-2 uppercase flex items-center justify-center gap-2"><i className="ri-line-chart-line text-orange-500"></i> Tendencia de Gasto (Burn Rate)</h4><TrendLineChart transactions={monthlyTransactions} totalBudget={totalMonthlyBudget} daysInMonth={daysInCurrentMonth} /></div>
                    </div>
                );
            };

            const SummaryView = () => {
                const totalIncome = monthlyIncomes.reduce((acc, i) => acc + i.amount, 0); const totalExpenses = monthlyTransactions.reduce((acc, t) => acc + t.amount, 0); const savings = totalIncome - totalExpenses; const savingsRate = totalIncome > 0 ? (savings / totalIncome) * 100 : 0;
                
                const sectionData = Object.entries(data.budgetConfig).map(([secName, config]) => { const spent = monthlyTransactions.filter(t => t.section === secName).reduce((sum, t) => sum + t.amount, 0); const diff = config.limit - spent; const percent = config.limit > 0 ? (spent / config.limit) * 100 : 0; return { name: secName, limit: config.limit, spent, diff, percent }; });
                let allCategories = []; Object.entries(data.budgetConfig).forEach(([secName, config]) => { Object.entries(config.categories).forEach(([catName, limit]) => { const spent = monthlyTransactions.filter(t => t.category === catName && t.section === secName).reduce((sum, t) => sum + t.amount, 0); const diff = limit - spent; const percent = limit > 0 ? (spent / limit) * 100 : 0; allCategories.push({ section: secName, name: catName, limit, spent, diff, percent }); }); });
                
                const targetDate = new Date(data.targetDate);
                const now = new Date();
                const timeDiff = targetDate - now;
                const daysRemaining = Math.max(0, Math.ceil(timeDiff / (1000 * 60 * 60 * 24)));
                const yearsRemaining = Math.max(0, Math.floor(daysRemaining / 365));
                const summersRemaining = yearsRemaining;
                
                const personalSection = sectionData.find(s => s.name === 'PERSONALES');
                let wolfAdvice = "";
                if (daysRemaining <= 0) wolfAdvice = "¬°La hora ha llegado! Si has seguido el plan, eres libre.";
                else if (personalSection && personalSection.percent < 40 && daysInCurrentMonth > 20) wolfAdvice = "Consejo: Tienes " + daysRemaining.toLocaleString() + " d√≠as restantes. No los desperdicies ahorrando de m√°s. Gasta en una experiencia hoy.";
                else if (savingsRate < 20) wolfAdvice = "Ojo: El reloj no se detiene. Si no aumentas tu ahorro, el d√≠a 0 llegar√° y no estar√°s listo.";
                else wolfAdvice = "Buen ritmo. Est√°s comprando tu libertad, un d√≠a a la vez.";
                
                const targetDateFormatted = new Intl.DateTimeFormat('es-MX', { day: 'numeric', month: 'long', year: 'numeric' }).format(targetDate);

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="flex items-center justify-between bg-slate-800 p-4 rounded-xl border border-slate-700 mb-6">
                            <button onClick={() => { const d = new Date(currentDate); d.setMonth(d.getMonth()-1); setCurrentDate(d); }} className="btn btn-ghost"><i className="ri-arrow-left-s-line"></i></button>
                            <div className="text-center"><div className="text-xs text-yellow-400 font-bold tracking-widest uppercase">Estrategia & Resultados</div><div className="text-2xl font-bold text-white uppercase">{formatMonth(`${activeMonthKey}-01`)}</div></div>
                            <button onClick={() => { const d = new Date(currentDate); d.setMonth(d.getMonth()+1); setCurrentDate(d); }} className="btn btn-ghost"><i className="ri-arrow-right-s-line"></i></button>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="panel p-4 text-center border-l-4 border-green-500"><div className="text-[10px] text-gray-400 uppercase font-bold">Ingresos</div><div className="text-xl md:text-2xl font-bold text-white">${totalMonthlyIncome.toLocaleString()}</div></div>
                            <div className="panel p-4 text-center border-l-4 border-red-500"><div className="text-[10px] text-gray-400 uppercase font-bold">Gastos Reales</div><div className="text-xl md:text-2xl font-bold text-white">${totalMonthlyExpenses.toLocaleString()}</div></div>
                            <div className="panel p-4 text-center border-l-4 border-blue-500 bg-slate-800"><div className="text-[10px] text-gray-400 uppercase font-bold">Ahorro Neto</div><div className={`text-xl md:text-2xl font-bold ${savings >= 0 ? 'text-blue-400' : 'text-red-400'}`}>${savings.toLocaleString()}</div></div>
                            <div className="panel p-4 text-center border-l-4 border-purple-500"><div className="text-[10px] text-gray-400 uppercase font-bold">Tasa Ahorro</div><div className="text-xl md:text-2xl font-bold text-white">{savingsRate.toFixed(1)}%</div></div>
                        </div>
                        <div className="panel bg-slate-900 border-2 border-red-900 shadow-xl relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-4 opacity-10"><i className="ri-timer-flash-line text-9xl text-red-500"></i></div>
                            <div className="relative z-10">
                                <div className="flex items-center gap-2 mb-6 border-b border-gray-800 pb-2"><i className="ri-flag-2-line text-red-500 text-xl"></i><h3 className="font-bold text-lg text-white">PROYECTO LIBERTAD: CUENTA REGRESIVA</h3></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                                    <div className="text-center md:text-left">
                                        <div className="text-gray-500 text-sm mb-1 uppercase tracking-widest">Tiempo Restante de Trabajo</div>
                                        <div className="text-5xl md:text-6xl font-bold text-white digital-clock font-mono">{daysRemaining.toLocaleString()}<span className="text-lg text-red-500 ml-2">D√çAS</span></div>
                                        <div className="text-sm text-gray-400 mt-2 flex items-center justify-center md:justify-start gap-2">Fecha Objetivo: <span className="text-white font-bold">{targetDateFormatted}</span><button onClick={() => setTargetDateModalOpen(true)} className="text-blue-400 hover:text-white transition" title="Cambiar fecha"><i className="ri-pencil-line"></i></button></div>
                                    </div>
                                    <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                                        <div className="flex justify-between items-center mb-2"><span className="text-xs text-yellow-500 font-bold uppercase"><i className="ri-sun-line"></i> Veranos Restantes</span><span className="text-xl font-bold text-white">{summersRemaining}</span></div>
                                        <div className="w-full bg-slate-700 h-2 rounded-full mb-4"><div className="bg-yellow-500 h-full" style={{width: `${Math.min(100, (summersRemaining/45)*100)}%`}}></div></div>
                                        <p className="text-gray-300 italic text-xs leading-relaxed border-l-2 border-red-500 pl-3">"{wolfAdvice}"</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="panel overflow-hidden">
                            <h3 className="font-bold mb-4 text-blue-400 uppercase text-sm tracking-wider">Balance T√°ctico por Secci√≥n</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left border-collapse">
                                    <thead className="bg-slate-900 text-xs text-gray-400 uppercase"><tr><th className="p-3">Secci√≥n</th><th className="p-3 text-right">Presupuesto</th><th className="p-3 text-right">Gastado</th><th className="p-3 text-right">Diferencia</th><th className="p-3 text-center">% Real</th></tr></thead>
                                    <tbody className="divide-y divide-slate-700 font-mono">
                                        {sectionData.map((row, idx) => {
                                            const isSavings = row.name.includes('AHORRO');
                                            const isGood = isSavings ? row.diff <= 0 : row.diff >= 0; 
                                            return (<tr key={idx} className="hover:bg-slate-800/50"><td className="p-3 font-sans font-bold text-slate-200">{row.name}</td><td className="p-3 text-right text-gray-400">${row.limit.toLocaleString()}</td><td className="p-3 text-right text-white font-bold">${row.spent.toLocaleString()}</td><td className={`p-3 text-right font-bold ${isGood ? 'text-green-400' : 'text-red-400'}`}>{row.diff > 0 ? '+' : ''}{row.diff.toLocaleString()}</td><td className="p-3 text-center"><span className={`px-2 py-0.5 rounded text-xs ${row.percent > 100 ? 'bg-red-900 text-red-200' : 'bg-green-900 text-green-200'}`}>{row.percent.toFixed(1)}%</span></td></tr>);
                                        })}
                                        <tr className="bg-slate-800/80 font-bold border-t-2 border-slate-600"><td className="p-3 text-white">TOTALES</td><td className="p-3 text-right text-white">${Object.values(data.budgetConfig).reduce((a,b)=>a+b.limit,0).toLocaleString()}</td><td className="p-3 text-right text-white">${totalExpenses.toLocaleString()}</td><td className="p-3 text-right text-gray-400">-</td><td className="p-3 text-center">-</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            const EditModal = () => { if (!editingItem) return null; const [val, setVal] = useState(editingItem.value); const [rate, setRate] = useState(editingItem.rate || 0); const [name, setName] = useState(editingItem.name); return (<div className="modal-overlay"><div className="modal-content animate-fade-in"><h3 className="font-bold text-xl mb-4 text-blue-400">Editar Detalle</h3><label className="block text-xs text-gray-400 mb-1">Nombre</label><input type="text" value={name} onChange={e => setName(e.target.value)} className="input-dark mb-3" /><label className="block text-xs text-gray-400 mb-1">Saldo Total</label><input type="number" value={val} onChange={e => setVal(e.target.value)} className="input-dark mb-4 text-2xl font-mono" />{editingItem.itemType === 'debt' && (<><label className="block text-xs text-gray-400 mb-1">Tasa Inter√©s (%)</label><input type="number" value={rate} onChange={e => setRate(e.target.value)} className="input-dark mb-4" /></>)}<div className="flex justify-end gap-2 mt-4"><button onClick={() => setEditingItem(null)} className="btn bg-slate-600 hover:bg-slate-500 text-white">Cancelar</button><button onClick={() => updateItem(editingItem.itemType, editingItem.id, val, rate, name)} className="btn btn-primary">Guardar</button></div></div></div>); };
            const TransactionEditModal = () => { 
                if (!editingTx) return null; 
                const [amt, setAmt] = useState(editingTx.amount); 
                const [cmt, setCmt] = useState(editingTx.comment); 
                const [sec, setSec] = useState(editingTx.section || Object.keys(data.budgetConfig)[0]); 
                const [cat, setCat] = useState(editingTx.category || editingTx.source); 
                const [date, setDate] = useState(editingTx.date); 
                const isIncome = editingTx.type === 'income'; 
                const currentSection = data.budgetConfig[sec] || { categories: {} }; 
                const categories = Object.keys(currentSection.categories); 
                return (
                    <div className="modal-overlay">
                        <div className="modal-content animate-fade-in">
                            <h3 className="font-bold text-xl mb-4 text-yellow-400">Corregir Movimiento</h3>
                            <label className="block text-xs text-gray-400 mb-1">Fecha</label>
                            <input type="date" value={date} onChange={e => setDate(e.target.value)} className="input-dark mb-3" />
                            <label className="block text-xs text-gray-400 mb-1">Monto</label>
                            <input type="number" value={amt} onChange={e => setAmt(e.target.value)} className="input-dark mb-3 text-xl font-mono" />
                            <label className="block text-xs text-gray-400 mb-1">Comentario</label>
                            <input type="text" value={cmt} onChange={e => setCmt(e.target.value)} className="input-dark mb-3" />
                            {!isIncome ? (<>
                                <label className="block text-xs text-gray-400 mb-1">Secci√≥n</label>
                                <select value={sec} onChange={e => {setSec(e.target.value); setCat(Object.keys(data.budgetConfig[e.target.value].categories)[0])}} className="input-dark mb-3">{Object.keys(data.budgetConfig).map(s => <option key={s} value={s}>{s}</option>)}</select>
                                <label className="block text-xs text-gray-400 mb-1">Categor√≠a</label>
                                <select value={cat} onChange={e => setCat(e.target.value)} className="input-dark mb-3">{categories.map(c => <option key={c} value={c}>{c}</option>)}</select>
                            </>) : (<>
                                <label className="block text-xs text-gray-400 mb-1">Fuente</label>
                                <select value={cat} onChange={e => setCat(e.target.value)} className="input-dark mb-3"><option value="SALARIO">Salario N√≥mina</option><option value="VALES">Vales de Despensa</option><option value="AGUINALDO">Aguinaldo</option><option value="FONDO AHORRO">Fondo de Ahorro</option><option value="EXTRA">Ingreso Extra / Venta</option></select>
                            </>)}
                            <div className="flex justify-end gap-2 mt-4">
                                <button onClick={() => setEditingTx(null)} className="btn bg-slate-600 hover:bg-slate-500 text-white">Cancelar</button>
                                <button onClick={() => saveTransactionChanges(editingTx.id, editingTx.type, amt, cmt, cat, sec, date)} className="btn btn-primary">Guardar Cambios</button>
                            </div>
                        </div>
                    </div>
                ); 
            };
            const PaymentModal = () => { if (!paymentItem) return null; const [amount, setAmount] = useState(""); const isAsset = paymentItem.type === 'asset'; return (<div className="modal-overlay"><div className="modal-content animate-fade-in border-t-4 border-yellow-500"><h3 className="font-bold text-xl mb-2 text-white">{isAsset ? 'üí∞ Inyectar Ahorro' : '‚öîÔ∏è Abonar a Deuda'}</h3><p className="text-sm text-gray-400 mb-4">{isAsset ? 'Sumar dinero a:' : 'Restar deuda a:'} <span className="text-white font-bold">{paymentItem.item.name}</span></p><label className="block text-xs text-gray-500 mb-1">Cantidad a {isAsset ? 'Ingresar' : 'Pagar'}</label><input type="number" autoFocus value={amount} onChange={e => setAmount(e.target.value)} className="input-dark mb-6 text-2xl font-mono text-center" placeholder="$0.00" /><div className="flex justify-end gap-2"><button onClick={() => setPaymentItem(null)} className="btn btn-ghost">Cancelar</button><button onClick={() => handlePayment(amount)} className={`btn ${isAsset ? 'btn-success' : 'btn-danger'}`}>{isAsset ? 'Sumar (+)' : 'Restar (-)'}</button></div></div></div>); };
            const TargetDateModal = () => { if (!targetDateModalOpen) return null; const [tempDate, setTempDate] = useState(data.targetDate); return (<div className="modal-overlay"><div className="modal-content animate-fade-in border-t-4 border-red-500 max-w-sm"><h3 className="font-bold text-xl mb-4 text-white">üìÖ Definir Fecha de Retiro</h3><p className="text-gray-400 text-sm mb-4">Selecciona la fecha exacta en la que quieres colgar los guantes. Tu cuenta regresiva se ajustar√°.</p><input type="date" value={tempDate} onChange={(e) => setTempDate(e.target.value)} className="input-dark text-center text-xl mb-6" /><div className="flex justify-end gap-2"><button onClick={() => setTargetDateModalOpen(false)} className="btn btn-ghost">Cancelar</button><button onClick={() => updateTargetDate(tempDate)} className="btn btn-primary">Confirmar</button></div></div></div>); };
            const BudgetConfigModal = () => { const [newCatName, setNewCatName] = useState(""); const [newCatLimit, setNewCatLimit] = useState(""); const [activeSectionForAdd, setActiveSectionForAdd] = useState(null); const [newSectionName, setNewSectionName] = useState(""); if (!configModalOpen) return null; return (<div className="modal-overlay"><div className="modal-content animate-fade-in max-w-2xl"><div className="flex justify-between items-center mb-6 border-b border-gray-700 pb-2"><h3 className="font-bold text-2xl text-blue-400">‚öôÔ∏è Configuraci√≥n del Plan</h3><button onClick={() => setConfigModalOpen(false)} className="text-gray-400 hover:text-white"><i className="ri-close-line text-2xl"></i></button></div><div className="space-y-8">{Object.entries(data.budgetConfig).map(([secName, config]) => (<div key={secName} className="bg-slate-800/50 p-4 rounded-lg border border-slate-700"><div className="flex justify-between items-center mb-4"><div className="flex items-center gap-2"><h4 className="font-bold text-lg text-white">{secName}</h4><button onClick={() => deleteBudgetSection(secName)} className="text-red-500 hover:text-red-300 text-xs" title="Borrar Secci√≥n"><i className="ri-delete-bin-line"></i></button></div><div className="flex items-center gap-2"><label className="text-xs text-gray-500">L√≠mite Mensual:</label><input type="number" value={config.limit} onChange={(e) => updateBudgetSectionLimit(secName, e.target.value)} className="input-dark w-24 text-right font-mono text-blue-300 border-blue-900/50"/></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">{Object.entries(config.categories).map(([catName, limit]) => (<div key={catName} className="flex justify-between items-center bg-slate-900 p-2 rounded text-sm group"><span className="text-gray-300">{catName}</span><div className="flex items-center gap-2"><input type="number" value={limit} onChange={(e) => updateBudgetCategoryLimit(secName, catName, e.target.value)} className="input-dark w-20 text-right py-1 text-xs"/><button onClick={() => deleteBudgetCategory(secName, catName)} className="text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition"><i className="ri-close-circle-line"></i></button></div></div>))}</div><div className="flex gap-2 items-center mt-2 border-t border-slate-700 pt-2"><input placeholder={`Nueva categor√≠a en ${secName}...`} className="input-dark text-xs flex-1" value={activeSectionForAdd === secName ? newCatName : ""} onChange={(e) => { setActiveSectionForAdd(secName); setNewCatName(e.target.value); }} onFocus={() => setActiveSectionForAdd(secName)}/><input type="number" placeholder="$ Limite" className="input-dark text-xs w-20" value={activeSectionForAdd === secName ? newCatLimit : ""} onChange={(e) => { setActiveSectionForAdd(secName); setNewCatLimit(e.target.value); }}/><button onClick={() => { addBudgetCategory(secName, newCatName, newCatLimit); setNewCatName(""); setNewCatLimit(""); }} className="btn btn-sm btn-primary"><i className="ri-add-line"></i></button></div></div>))}<div className="bg-slate-800/30 p-4 rounded-lg border border-dashed border-gray-600 flex justify-between items-center"><span className="text-sm font-bold text-gray-400">NUEVA SECCI√ìN PRINCIPAL</span><div className="flex gap-2"><input placeholder="Nombre Secci√≥n (Ej. LUJOS)" className="input-dark text-sm w-48" value={newSectionName} onChange={(e) => setNewSectionName(e.target.value)}/><button onClick={() => { addBudgetSection(newSectionName); setNewSectionName(""); }} className="btn btn-sm btn-success">Crear Secci√≥n</button></div></div></div><div className="mt-8 flex justify-end"><button onClick={() => setConfigModalOpen(false)} className="btn btn-primary w-full md:w-auto">Guardar y Cerrar</button></div></div></div>); };

            return (
                <div className="min-h-screen pb-20 md:pb-0 md:pl-64">
                    {editingItem && <EditModal />}
                    {editingTx && <TransactionEditModal />} 
                    {paymentItem && <PaymentModal />} 
                    {configModalOpen && <BudgetConfigModal />}
                    {targetDateModalOpen && <TargetDateModal />}

                    {/* Status de Sincronizaci√≥n */}
                    <div className="fixed top-2 right-2 z-50">
                        {syncStatus === 'syncing' && <span className="bg-yellow-600 text-white text-[10px] px-2 py-1 rounded-full opacity-75 animate-pulse">Guardando...</span>}
                        {syncStatus === 'saved' && <span className="bg-green-600 text-white text-[10px] px-2 py-1 rounded-full opacity-75 transition-opacity duration-1000">Sincronizado</span>}
                        {syncStatus === 'error' && <span className="bg-red-600 text-white text-[10px] px-2 py-1 rounded-full">Error de Conexi√≥n</span>}
                    </div>

                    <div className="hidden md:flex flex-col w-64 fixed inset-y-0 left-0 bg-slate-900 border-r border-slate-700 p-4">
                        <h1 className="text-2xl font-bold text-blue-500 mb-1 tracking-tighter">PLAN LOBO üê∫</h1>
                        <p className="text-xs text-slate-500 mb-8">V7.1 Visionario</p>
                        <nav className="space-y-2">
                            <button onClick={() => setView('global')} className={`w-full text-left p-3 rounded flex items-center gap-3 ${view === 'global' ? 'bg-blue-600 shadow-lg' : 'hover:bg-slate-800 text-gray-400'}`}><i className="ri-earth-line text-xl"></i> Global</button>
                            <button onClick={() => setView('monthly')} className={`w-full text-left p-3 rounded flex items-center gap-3 ${view === 'monthly' ? 'bg-purple-600 shadow-lg' : 'hover:bg-slate-800 text-gray-400'}`}><i className="ri-calendar-line text-xl"></i> Mensual</button>
                            <button onClick={() => setView('summary')} className={`w-full text-left p-3 rounded flex items-center gap-3 ${view === 'summary' ? 'bg-yellow-600 shadow-lg' : 'hover:bg-slate-800 text-white'}`}><i className="ri-file-list-3-line text-xl"></i> Estrategia</button>
                            <button onClick={() => setView('simulator')} className={`w-full text-left p-3 rounded flex items-center gap-3 ${view === 'simulator' ? 'bg-indigo-600 shadow-lg' : 'hover:bg-slate-800 text-gray-400'}`}><i className="ri-rocket-2-line text-xl"></i> Simulador</button>
                        </nav>
                    </div>
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-700 flex justify-around p-4 z-50">
                        <button onClick={() => setView('global')} className={`flex flex-col items-center ${view === 'global' ? 'text-blue-400' : 'text-gray-500'}`}><i className="ri-earth-line text-2xl"></i></button>
                        <button onClick={() => setView('monthly')} className={`flex flex-col items-center ${view === 'monthly' ? 'text-purple-400' : 'text-gray-500'}`}><i className="ri-calendar-line text-2xl"></i></button>
                        <button onClick={() => setView('summary')} className={`flex flex-col items-center ${view === 'summary' ? 'text-yellow-400' : 'text-gray-500'}`}><i className="ri-file-list-3-line text-2xl"></i></button>
                        <button onClick={() => setView('simulator')} className={`flex flex-col items-center ${view === 'simulator' ? 'text-indigo-400' : 'text-gray-500'}`}><i className="ri-rocket-2-line text-2xl"></i></button>
                    </div>
                    <main className="p-4 md:p-8 max-w-6xl mx-auto">
                        <div className="md:hidden mb-4 flex justify-between items-center"><h1 className="text-xl font-bold text-blue-500">PLAN LOBO üê∫ V7.1</h1></div>
                        {view === 'global' && <GlobalView />}
                        {view === 'monthly' && <MonthlyView />}
                        {view === 'summary' && <SummaryView />}
                        {view === 'simulator' && <SimulatorView />}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>